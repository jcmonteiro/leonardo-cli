#!/usr/bin/env sh

set -eu

staged_go_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$staged_go_files" ]; then
	exit 0
fi

if ! command -v golangci-lint >/dev/null 2>&1; then
	echo "golangci-lint not found in PATH.  Install it before committing." >&2
	exit 1
fi

printf '%s\n' "$staged_go_files" | while IFS= read -r file; do
	if [ -n "$file" ]; then
		go fmt "$file"
		git add "$file"
	fi
done
golangci-lint run ./...
